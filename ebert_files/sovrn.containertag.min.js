/*(c)2016 sovrn Holdings, Inc. All Rights Reserved 1487106875635*/
window.sovrn=window.sovrn||{};sovrn.config=sovrn.config||{},sovrn.config.ct=sovrn.config.ct||{current_tid:"",globals:{tag_regex:/^(https?:)?\/\/.*\.lijit\.(com|dev)(:\d+)?\/res\/sovrn\.containertag(\.min)?\.js/i,fired_tags:{}},instances:{},tag_functions:{}},sovrn.containerTag={buildConfig:{},buildQS:function(obj,enc){var i,output=[],encode_uri=encodeURIComponent,amp=enc?"&amp;":"&";for(i in obj)obj.hasOwnProperty(i)&&""!==i&&""!==obj[i]&&output.push(encode_uri(i)+"="+encode_uri(obj[i]));return output.join(amp)},checkFreq:function(tag){var cookie_val,first_int,second_int,third_int,fourth_int,modulo_val,return_val,tag_percent,_this=this;if("number"==typeof tag&&(tag=_this.getTagById(tag)),!tag.frequency)return!0;switch(tag.frequency){case"sample":tag_percent=parseFloat(tag.percent),0===tag_percent?(_this.setStatusCode(tag.id,"disabled"),return_val=!1):return_val=100===tag_percent||100*Math.random()<=(tag_percent||0);break;case"users":return_val=!1,100===parseInt(tag.percent,10)?return_val=!0:(modulo_val=Math.floor(1/((parseFloat(tag.percent)||0)/100)),cookie_val=_this.getData("ljt_reader"),32===cookie_val.length&&(first_int=parseInt(cookie_val.substr(0,8),16),second_int=parseInt(cookie_val.substr(8,8),16),third_int=parseInt(cookie_val.substr(16,8),16),fourth_int=parseInt(cookie_val.substr(24,8),16),return_val=(first_int+second_int+third_int+fourth_int)%modulo_val===0));break;case"timed":return_val=!0;break;default:_this.reportError("Invalid Tag Freq. Type",new Error),return_val=!1}return return_val===!1&&_this.setStatusCode(tag.id,"frequency_capped"),return_val},checkRules:function(tag,tid){var i,data_value,comparison_value,operand,rules,_this=this,rules_pass=!0,numeric_operands=["gt","gte","lt","lte"],array_operands=["ct","nct"];if("number"==typeof tag&&(tag=_this.getTagById(tag,tid)),!tag)return _this.reportError("checkRules: tag argument is required",new Error),!1;if(rules=tag.rules,0===rules.length)return!0;for(i=0;i<rules.length;i++){if(data_value=_this.getData(rules[i]["var"]),"undefined"==typeof data_value||""===data_value||null===data_value)return _this.log("Empty data_value detected in checkRules; Tag: "+tag.id),!1;if(operand=rules[i].operand,comparison_value=rules[i].value,numeric_operands.indexOf(operand)>=0&&(isNaN(data_value)||isNaN(comparison_value)))return _this.reportError("Numeric operand used on non-numeric data-layer var; Tag: "+tag.id,new Error),!1;if(array_operands.indexOf(operand)>=0&&!(data_value instanceof Array))return _this.reportError("Contains operator used on non-array data-layer var; Tag: "+tag.id,new Error),!1;switch(operand){case"eq":rules_pass=data_value+""==comparison_value+"";break;case"ne":rules_pass=data_value+""!=comparison_value+"";break;case"gt":rules_pass=parseFloat(data_value)>parseFloat(comparison_value);break;case"lt":rules_pass=parseFloat(data_value)<parseFloat(comparison_value);break;case"gte":rules_pass=parseFloat(data_value)>=parseFloat(comparison_value);break;case"lte":rules_pass=parseFloat(data_value)<=parseFloat(comparison_value);break;case"ct":rules_pass=data_value.indexOf(comparison_value)>=0;break;case"nct":rules_pass=-1===data_value.indexOf(comparison_value);break;default:return _this.log("checkRules: Unsupported Operand Detected; Tag: "+tag.id),!1}if(!rules_pass){_this.setStatusCode(tag.id,"rules_did_not_pass");break}}return rules_pass},createBitmask:function(){var mask=0,flag=0,len=arguments.length>32?32:arguments.length;for(flag;len>flag;mask|=arguments[flag]<<flag++);return mask},createScript:function(src,id){var script_elem;return script_elem=document.createElement("script"),script_elem.type="text/javascript",script_elem.src=src,id&&(script_elem.id=id),script_elem},dataCallback:function(container_data){var config=this.getConfig();return config.data=container_data,this.setupDataLayer(),this.fireTags(),!0},dbgEnabled:function(){var is_debug_enabled;try{is_debug_enabled=localStorage.getItem("debug")}catch(e){}return is_debug_enabled=is_debug_enabled||(document.cookie.match(/(^|; )debug=([^;]*)/)||0)[2],1==is_debug_enabled},debug:function(val){val=parseInt(val,10);try{localStorage.setItem("debug",val)}catch(e){document.cookie="debug="+val+"; expires=Tue, 19 Jan 2038 00:00:00 GMT; path=/;"}return this.dbgEnabled()},fireTag:function(tag){function logFireTagError(tag,exception){var ct=sovrn.containerTag;return ct.log("ERROR FIRING TAG "+tag.id),ct.setStatusCode(tag.id,"js_error"),ct.reportError("Tag "+tag.id+": "+tag.error.replace(/["']/g,""),exception),!1}var _this=this,config=_this.getConfig(),query_params,image_src,image_src_char;switch("number"==typeof tag&&(tag=_this.getTagById(tag)),tag.type){case"img":try{query_params=_this.buildQS(_this.getTagParams(tag)),0===query_params.length?image_src=tag.src:(image_src_char=tag.src.indexOf("?")>=0?"&":"?",image_src=tag.src+image_src_char+query_params),(new Image).src=image_src,config.img_tags_fired++}catch(e){return logFireTagError(tag,e)}break;case"script":try{if(eval(tag.src)===!1)return _this.setStatusCode(tag.id,"custom_js_logic_failed"),!1;config.script_tags_fired++}catch(e){return logFireTagError(tag,e)}}return _this.getGlobalConfig().fired_tags[tag.id]=config.fired_tags[tag.id]=tag.id,config.total_tags_fired++,_this.setStatusCode(tag.id,"fired"),config.tss.push(new Date-config.start_time),!0},fireTags:function(){var i,config,tag,should_tag_fire,freq_check,rules_pass,everything_passes,fired_image_tags,fired_script_tags,tag_fired,_this=this;for(config=_this.getConfig(),fired_script_tags=[],fired_image_tags=[],i=0;i<config.data.tags.length;i++)tag=config.data.tags[i],config.tag_status_codes[tag.id]=new _this.statusCodesConst,freq_check=_this.checkFreq(tag),should_tag_fire=!_this.isPageCapped(tag),rules_pass=_this.checkRules(tag),everything_passes=freq_check&&should_tag_fire&&rules_pass,_this.dbgEnabled()&&_this.log("CID: "+config.container_id+" Tag: "+tag.id+" ("+tag.type+") Not Page Capped: "+should_tag_fire+" | Rules Passed: "+rules_pass+" | Freq Check Passed: "+freq_check+" | FIRED: "+everything_passes),everything_passes&&(tag_fired=_this.fireTag(tag),tag_fired&&("img"===tag.type?fired_image_tags.push(tag.id):"script"===tag.type&&fired_script_tags.push(tag.id)));_this.log("Fired Image Tags: "+fired_image_tags.join(", ")+" / Script Tags: "+fired_script_tags.join(", ")),_this.logToServer()},getBrowserEngine:function(win,doc){var style,engine;win=win||window,doc=doc||document,style=doc.documentElement.style,engine="un";try{win.chrome?engine="cr":win.ActiveXObject||"-ms-ime-align"in style?engine="ie":"mozInnerScreenX"in win&&"mozFullScreen"in doc||"MozAppearance"in style?engine="fx":"WebKitCSSMatrix"in win||"WebKitPoint"in win||"webkitStorageInfo"in win||"webkitURL"in win?engine="sf":("OLink"in style||win.opera)&&(engine="op")}catch(e){this.dbg(e)}return engine},getBuildConfig:function(){var _this=this;_this.ct_url="//ap.lijit.com/containertag",_this.log_url="//ap.lijit.com/data/ct",_this.error_url="//ap.lijit.com/data/errors",Object.seal&&Object.seal(_this)},getConfig:function(tid){return tid=tid||sovrn.config.ct.current_tid,sovrn.config.ct.current_tid=tid,"undefined"==typeof sovrn.config.ct.instances[tid]&&(sovrn.config.ct.instances[tid]={}),sovrn.config.ct.instances[tid]},getConfigByIndex:function(index){var i,counter=0;for(i in sovrn.config.ct.instances)if(sovrn.config.ct.instances.hasOwnProperty(i)){if(counter===index)return sovrn.config.ct.instances[i];counter++}return!1},getData:function(key){var data_layer_value,config_value;return data_layer_value=this.getDataLayerValue(key),null!==data_layer_value?data_layer_value:(config_value=this.getConfigValue(key),null!==config_value?config_value:null)},getConfigValue:function(key,tid){var config=this.getConfig(tid);return config.data&&config.data.hasOwnProperty(key)?config.data[key]:null},getDataLayerValue:function(key){return sovrn.dataLayer instanceof Array&&sovrn.dataLayer[0]&&sovrn.dataLayer[0].hasOwnProperty(key)?sovrn.dataLayer[0][key]:null},getDataFromServer:function(container_id,zone_id,aff_id){var script_element,id_param,data_uri,_this=this;return zone_id=zone_id||_this.getQueryParam("zid"),aff_id=aff_id||_this.getQueryParam("aid"),(container_id=container_id||_this.getConfig().container_id||_this.getQueryParam("cid"))?zone_id||aff_id?(aff_id?id_param="affId="+aff_id:zone_id&&(id_param="zoneId="+zone_id),data_uri=_this.buildConfig.ct_url+"?containerId="+container_id+"&"+id_param+"&v=2",script_element=_this.createScript(data_uri),document.writeln(script_element.outerHTML),_this.log("*ct: Retrieved Config from Server/Cache"),!0):(_this.reportError("Missing Zone ID and Affiliate ID",new Error),!1):(_this.reportError("Missing Container ID",new Error),!1)},getGlobalConfig:function(win){return win=win||window,win.sovrn.config.ct.globals},getGUID:function(){function b(a){return a?(a^16*Math.random()>>a/4).toString(16):([1e7]+1e3+4e3+8e3+1e19).replace(/[018]/g,b)}return b()},getQueryParam:function(key,tid){var params=this.getConfig(tid).query_params||{};return params.hasOwnProperty(key)?params[key]:null},getScriptTag:function(){var script_tags,i,cur_script,script_pattern=this.getGlobalConfig().tag_regex;if("currentScript"in document&&(cur_script=document.currentScript,cur_script&&script_pattern.test(cur_script.src)))return cur_script;for(script_tags=document.getElementsByTagName("script"),i=script_tags.length-1;i>=0;i--)if(script_pattern.test(script_tags[i].src))return script_tags[i];return null},setStatusCode:function(tag_id,status_code){var config=this.getConfig();try{config.tag_status_codes&&"object"==typeof config.tag_status_codes[tag_id]&&(config.tag_status_codes[tag_id][status_code]=!0)}catch(e){return this.reportError("Error Setting Status Code: "+status_code+" for Tag: "+tag_id,e),!1}return!0},getStatusCodes:function(tid){var tsc,tag_status,tag_status_codes_arr,return_val=[],tag_status_codes=this.getConfig(tid).tag_status_codes;for(tag_status in tag_status_codes)tag_status_codes.hasOwnProperty(tag_status)&&(tsc=tag_status_codes[tag_status],tag_status_codes_arr=[tsc.fired,tsc.disabled,tsc.frequency_capped,tsc.rules_did_not_pass,tsc.once_per_page_capped,tsc.custom_js_logic_failed,tsc.js_error],return_val.push(this.createBitmask.apply(this,tag_status_codes_arr)));return return_val},getTagParams:function(tag){var i,output;for(output={},i=0;i<tag.params.length;i++)output[tag.params[i].key]=this.getData(tag.params[i]["var"])+"";return output},getTagById:function(id,tid){var my_tags,i,tag;for(my_tags=this.getTags(tid),i=0;i<my_tags.length;i++)if(tag=my_tags[i],parseInt(tag.id,10)===parseInt(id,10))return tag;return null},getTagIds:function(tid,only_fired){var i,output=[],my_tags=this.getTags(tid,only_fired);for(i=0;i<my_tags.length;i++)output.push(my_tags[i].id);return output},getTags:function(tid,only_fired){var i,fired_tag_ids,tag_id,fired_tags=[],config=this.getConfig(tid),all_tags=config.data.tags;if(only_fired){for(fired_tag_ids=config.fired_tags,i=0;i<all_tags.length;i++)tag_id=parseInt(all_tags[i].id,10),fired_tag_ids.hasOwnProperty(tag_id)&&fired_tags.push(all_tags[i]);return fired_tags}return all_tags},getTID:function(){return this.getConfig().tid},init:function(tid,container_id,zone_id,aff_id){var config,my_script,ct_identifier,_this=this;if(_this.isOldIE())return _this.log("Legacy IE detected; Aborting"),!1;if(sovrn.config.ct.instances.hasOwnProperty(tid))return _this.log("Container Tag already fired for tid:"+tid),!1;if(_this.buildConfig=new _this.getBuildConfig,delete sovrn.config.ct.current_tid,sovrn.config.ct.current_tid=tid=tid||_this.getGUID(),config=_this.getConfig(tid),config.start_time=+new Date,config.elapsed_ms=0,config.tss=[],config.tid=tid,config.zone_id=zone_id||null,config.query_params={},config.data={},config.fired_tags={},config.all_tag_ids=[],config.fired_tag_ids=[],config.img_tags_fired=0,config.script_tags_fired=0,config.total_tags_fired=0,config.log="",config.tag_status_codes={},_this.log("Container Tag Start"),!container_id&&!zone_id&&!aff_id){if(my_script=_this.getScriptTag(),!my_script)return _this.reportError("Could not find CT script tag",new Error),!1;config.query_params=_this.parseQueryString(my_script.src)}return config.container_id=container_id=container_id||_this.getQueryParam("cid"),container_id?(sovrn.containers=sovrn.containers||{},ct_identifier="ct"+container_id,sovrn.containers[ct_identifier]=sovrn.containers[ct_identifier]||{getData:sovrn.containerTag.getData,getDataLayerValue:sovrn.containerTag.getDataLayerValue,getConfigValue:sovrn.containerTag.getConfigValue,getConfig:sovrn.containerTag.getConfig},_this.getDataFromServer(container_id,zone_id,aff_id)):(_this.reportError("Missing cid",new Error),!1)},isOldIE:function(user_agent_string){var pattern=new RegExp("MSIE ([0-9]+[\\.0-9]*)");return user_agent_string=user_agent_string||navigator.userAgent,"ie"===this.getBrowserEngine()&&!!pattern.exec(user_agent_string)&&parseInt(RegExp.$1)<10},log:function(msg){var ts,log_line,config,log_style="",style_templ="";return"undefined"!=typeof console&&this.dbgEnabled()?(config=this.getConfig(),ts=new Date-config.start_time,log_line="[sovrn.ct] "+ts+": "+msg+" ("+this.getTID()+")","ie"!==this.getBrowserEngine()&&(style_templ="%c",log_style="background-color: #FFED96"),console.log(style_templ+log_line,log_style),config.log+=log_line+"\n",!0):!1},logToServer:function(){var log_params,_this=this,config=_this.getConfig(),log_url=_this.buildConfig.log_url,fired_tag_ids=_this.getTagIds(null,!0);log_params={tid:_this.getTID(),zoneid:config.zone_id,cid:config.container_id,geo:config.data.geo||"",all_tags:_this.getTagIds().join(","),tss:config.tss.join(","),fired_tags:fired_tag_ids.join(","),count:fired_tag_ids.length,status:_this.getStatusCodes().join(",")},config.elapsed_ms=log_params.elapsed_ms=new Date-config.start_time,(new Image).src=log_url+"?"+_this.buildQS(log_params),_this.log("Logged Container Tag Successfully")},parseQueryString:function(url){var query_string,qs_obj={};return query_string=url.split("?")[1]||"",(query_string=query_string.split("#")[0]||"")?(query_string.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function($0,$1,$2,$3){try{qs_obj[$1]=decodeURIComponent($3)}catch(e){sovrn.ct.dbg(e)}}),qs_obj):{}},reportError:function(msg,ex){var err_msg,stack_trace,error_handler_params,_this=this,zone_id=(_this.getConfig(),sovrn.ads&&sovrn.ads.getZoneID&&sovrn.ads.getZoneID()||"");try{stack_trace=ex&&ex.hasOwnProperty("stack")?ex.stack:"",error_handler_params={zoneid:zone_id,tid:this.getTID(),err:ex&&ex.hasOwnProperty("message")?ex.message:"",msg:msg,stack:stack_trace.substr(0,1024)},(new Image).src=_this.buildConfig.error_url+"/ct?"+_this.buildQS(error_handler_params),_this.dbgEnabled()&&(err_msg="CT JS ERROR: \n\n"+msg+"\n\n"+stack_trace,alert(err_msg),window.console&&console.error(err_msg))}catch(e){console.log(e)}return ex},setupDataLayer:function(){var data_layer_map,key,config_data=this.getConfig().data;sovrn.dataLayer=sovrn.dataLayer||[{}],data_layer_map={commscoreCategory:config_data.commscoreCategory||"",sovrnApplications:config_data.application_ids||[],sovrnGeo:config_data.geo||"",sovrnIid:config_data.user.iid||"",sovrnRandom:Math.floor(9e6*Math.random()),sovrnReader:config_data.ljt_reader||"",sovrnUser:config_data.user.username||""};for(key in data_layer_map)data_layer_map.hasOwnProperty(key)&&(sovrn.dataLayer[0][key]=data_layer_map[key])},isPageCapped:function(tag){var is_page_capped;return"number"==typeof tag&&(tag=this.getTagById(tag)),is_page_capped=!("multi"===tag.fire||!this.tagHasFired(tag.id)),is_page_capped&&this.setStatusCode(tag.id,"once_per_page_capped"),is_page_capped},statusCodesConst:function(){var _this=this;_this.fired=!1,_this.disabled=!1,_this.frequency_capped=!1,_this.rules_did_not_pass=!1,_this.once_per_page_capped=!1,_this.custom_js_logic_failed=!1,_this.js_error=!1,Object.seal&&Object.seal(_this)},tagHasFired:function(tag_id){if(!tag_id)throw new TypeError("Tag ID is required");return this.getGlobalConfig().fired_tags.hasOwnProperty(tag_id)}},sovrn.ct=sovrn.containerTag,"undefined"!=typeof Object.seal&&(sovrn.config.ct.globals=Object.seal(sovrn.config.ct.globals),sovrn.containerTag=Object.seal(sovrn.containerTag)),sovrn.ct.init();